from fastapi import APIRouter, Depends
from pydantic import BaseModel
from typing import List, Dict

from ..database import cases_collection
from ..auth import require_role

router = APIRouter()

class AnalyticsData(BaseModel):
    cases_by_status: Dict[str, int]
    lawyer_workload: Dict[str, int]
    monthly_filings: Dict[str, int]

@router.get("/", response_model=AnalyticsData)
async def get_analytics(current_user: dict = Depends(require_role("admin"))):
    
    # 1. Cases by Status
    status_pipeline = [
        {"$group": {"_id": "$status", "count": {"$sum": 1}}}
    ]
    status_data = await cases_collection.aggregate(status_pipeline).to_list(None)
    cases_by_status = {item["_id"]: item["count"] for item in status_data}

    # 2. Lawyer Workload (active cases)
    workload_pipeline = [
        {"$match": {"status": {"$ne": "Closed"}}},
        {"$group": {"_id": "$assigned_lawyer_email", "count": {"$sum": 1}}}
    ]
    workload_data = await cases_collection.aggregate(workload_pipeline).to_list(None)
    lawyer_workload = {item["_id"]: item["count"] for item in workload_data}
    
    # 3. Monthly Filings
    filings_pipeline = [
        {"$group": {
            "_id": {"$month": "$filing_date"},
            "count": {"$sum": 1}
        }},
        {"$sort": {"_id": 1}}
    ]
    filings_data = await cases_collection.aggregate(filings_pipeline).to_list(None)
    
    # Map month number to name
    month_map = {1: "Jan", 2: "Feb", 3: "Mar", 4: "Apr", 5: "May", 6: "Jun", 7: "Jul", 8: "Aug", 9: "Sep", 10: "Oct", 11: "Nov", 12: "Dec"}
    monthly_filings = {month_map.get(item["_id"], "Unknown"): item["count"] for item in filings_data}
    
    return AnalyticsData(
        cases_by_status=cases_by_status,
        lawyer_workload=lawyer_workload,
        monthly_filings=monthly_filings
    )
